---
- name: Mount volume and prepare the tracking server
  hosts: mlflow_env
  become: yes
  become_user: root
  
  tasks:
        
    - name: Copy volume setup script to mlflow env
      ansible.builtin.copy:
        src: /home/ubuntu/mlflow_on_openstack_automated/volumesetup.sh
        dest: /home/ubuntu

    - name: chmod +x for the volume setup script
      ansible.builtin.shell: sudo chmod ugo+x volumesetup.sh
          
          #install mysql and install pip has been moved to setup env yml
          #this auth dict solves the auth url missing error but gives err unauthorized 
          #- name: Mount volume to the machine
          #openstack.cloud.server_volume:
          #server: mlflow_env
          #volume: tracking_server_storage
          #auth:
          #auth_url: https://pouta.csc.fi:5001/v3
          # username: korolain
          # password: 
          # project_name: project_2004357
          #   project_domain_name: vesselai

      #- name: Prepare the volume; create partition, file system and dir to mount
      #ansible.builtin.shell: /home/ubuntu/volumesetup.sh

      #mysql prep commands in shell/mysql:
      #mkdir artifacts
      #sudo mlflow server --backend-store-uri mysql+pymysql://root:@localhost:3306/tracking --default-artifact-root /home/ubuntu/artifacts --host 0.0.0.0 
    - name: Create dirs for artifact and metrics stores (edit to volume+mysql later)
      ansible.builtin.shell: mkdir artifacts && mkdir metrics
      ignore_errors: yes

    - name: Launch the tracking server with 10h time limit
      ansible.builtin.shell: mlflow server --backend-store-uri /home/ubuntu/metrics --default-artifact-root /home/ubuntu/artifacts --host 0.0.0.0 &
      async: 36000
      poll: 0
      #
      #            ame: Create a MySQL database meeting tracking server requirements
      # community.mysql.mysql_db:
      #  login_unix_socket: /var/run/mysqld/mysqld.sock
      #  check_implicit_admin: true
      #  name: tracking_db
      #  state: present
       
      #- name: Change user authentication plugin in mysql
      #     community.mysql.mysql_user:
      #  login_unix_socket: /var/run/mysqld/mysqld.sock
      #  name: root
      #  plugin: mysql_native_password
      #  state: present 

